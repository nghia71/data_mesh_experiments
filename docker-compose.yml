version: "3.8"

services:
  kafka-1:
    build: 
      context: ./kafka
      dockerfile: Dockerfile
    image: nghiadh/kafka-kraft:1.0.0
    hostname: ${KRAFT_1_HOST_NAME}
    container_name: ${KRAFT_1_CONTAINER_NAME}
    # restart: always
    ports:
      - "${KRAFT_1_BROKER_PORT}:${KRAFT_1_BROKER_PORT}"
      - "${KRAFT_1_CONTROLLER_PORT}:${KRAFT_1_CONTROLLER_PORT}"
    networks:
      - backend
    environment:
      - KAFKA_STORAGE_UUID=${KAFKA_STORAGE_UUID}
      - KRAFT_HOSTNAME=${KRAFT_1_HOST_NAME}
      - KRAFT_BROKER_PORT=${KRAFT_1_BROKER_PORT}
      - KRAFT_CONTROLLER_PORT=${KRAFT_1_CONTROLLER_PORT}
      - PROCESS_ROLES=broker,controller
      - NODE_ID=${KRAFT_1_ID}
      - CONTROLLER_QUORUM_VOTERS=${KRAFT_QUORUM_VOTERS}
      - INTER_BROKER_LISTENER_NAME=PLAINTEXT
      - CONTROLLER_LISTENER_NAME=CONTROLLER
      - LISTENERS=PLAINTEXT://:${KRAFT_1_BROKER_PORT},CONTROLLER://:${KRAFT_1_CONTROLLER_PORT}
      - LISTENER_SECURITY_PROTOCOL_MAP=CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT,SSL:SSL,SASL_PLAINTEXT:SASL_PLAINTEXT,SASL_SSL:SASL_SSL
      - LOG_DIR=/tmp/server/kraft-combined-logs
      - KAFKA_HEAP_OPTS=${KAFKA_HEAP_OPTS}
    volumes:
      - "./vol${KRAFT_1_ID}/kafka-data:/var/lib/kafka/data"
      - "./vol${KRAFT_1_ID}/kafka-logs:/tmp/server/"

  kafka-2:
    build: 
      context: ./kafka
      dockerfile: Dockerfile
    image: nghiadh/kafka-kraft:1.0.0
    hostname: ${KRAFT_2_HOST_NAME}
    container_name: ${KRAFT_2_CONTAINER_NAME}
    # restart: always
    ports:
      - "${KRAFT_2_BROKER_PORT}:${KRAFT_2_BROKER_PORT}"
      - "${KRAFT_2_CONTROLLER_PORT}:${KRAFT_2_CONTROLLER_PORT}"
    networks:
      - backend
    environment:
      - KAFKA_STORAGE_UUID=${KAFKA_STORAGE_UUID}
      - PROCESS_ROLES=broker,controller
      - NODE_ID=${KRAFT_2_ID}
      - CONTROLLER_QUORUM_VOTERS=${KRAFT_QUORUM_VOTERS}
      - INTER_BROKER_LISTENER_NAME=PLAINTEXT
      - CONTROLLER_LISTENER_NAME=CONTROLLER
      - LISTENERS=PLAINTEXT://:${KRAFT_2_BROKER_PORT},CONTROLLER://:${KRAFT_2_CONTROLLER_PORT}
      - LISTENER_SECURITY_PROTOCOL_MAP=CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT,SSL:SSL,SASL_PLAINTEXT:SASL_PLAINTEXT,SASL_SSL:SASL_SSL
      - LOG_DIR=/tmp/server/kraft-combined-logs
      - KAFKA_HEAP_OPTS=${KAFKA_HEAP_OPTS}
    volumes:
      - "./vol${KRAFT_2_ID}/kafka-data:/var/lib/kafka/data"
      - "./vol${KRAFT_2_ID}/kafka-logs:/tmp/server/"

networks:
  backend:
    name: backend